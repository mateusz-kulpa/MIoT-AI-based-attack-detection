import pandas as pd
from fnvhash import fnv1a_32 as fasthash

def drop_non_security_features(df: pd.DataFrame) -> pd.DataFrame:
    columns_to_drop = [
        # Cechy skorelowana z innymi obecnymi
        'tcp.checksum',
        'mqtt.clientid_len',

        # mqtt.conflag. zawarte w mqtt.conflags
        'mqtt.conflag.passwd',
        'mqtt.conflag.qos',
        'mqtt.conflag.reserved',
        'mqtt.conflag.retain',
        'mqtt.conflag.willflag',

        # mqtt.conack. zbędne przy braku semantyki odpowiedzi
        'mqtt.conack.flags',
        'mqtt.conack.val',

        # Zbyt niska zmienność w ruchu, możliwa poweirzchnia ataku
        'tcp.hdr_len'
    ]

    columns_to_drop_existing = [col for col in columns_to_drop if col in df.columns]
    return df.drop(columns=columns_to_drop_existing)


def handle_failed_data(data):
    for column in data.columns:
        if column in dtype_dict == 7:
            data[column] = data[column].apply(lambda x: fasthash(str(x).encode('utf8')))
        try:
            data[column] = pd.to_numeric(data[column], errors='raise')
        except ValueError:
            print(f"Column '{column}' contains invalid data, hashing it.")
            data[column] = data[column].apply(lambda x: fasthash(str(x).encode('utf8')))


    return data

file_path_normal = r'*\traffic.csv'
file_path_attack = r'*\attack_reduced.csv'

#Pola tekstowe
dtype_dict = {
    6: str,
    21: str,
    24: str
}

data_attack = pd.read_csv(file_path_attack, sep=';', dtype=dtype_dict, low_memory=False)
data_normal = pd.read_csv(file_path_normal, sep=';', dtype=dtype_dict, low_memory=False)

data_attack = drop_non_security_features(data_attack)
data_normal = drop_non_security_features(data_normal)

print(data_attack.head(), len(data_attack))
print(data_normal.head(), len(data_normal))

data_attack = handle_failed_data(data_attack)
data_normal = handle_failed_data(data_normal)

print(data_attack.head())
print(data_normal.head())

data_attack.to_csv('hashed_attack.csv', index=False)
data_normal.to_csv('hashed_traffic.csv', index=False)

loaded_data = pd.read_csv('hashed_attack.csv')
print(loaded_data.head())
loaded_data = pd.read_csv('hashed_traffic.csv')
print(loaded_data.head())